name: Create ZIP and Release

on:
  workflow_dispatch:
    inputs:
      release_version:
        description: 'Optional: Release version (e.g., 1.0.0)'
        required: false
        type: string

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Get current date for filename
      id: date
      run: echo "::set-output name=today::$(date +'%Y-%m-%d')"

    - name: Determine Release Name and Tag
      id: release_info
      run: |
        if [[ -n "${{ github.event.inputs.release_version }}" ]]; then
          echo "::set-output name=tag_name::v${{ github.event.inputs.release_version }}"
          echo "::set-output name=release_name::Release v${{ github.event.inputs.release_version }}"
          echo "::set-output name=zip_filename::v${{ github.event.inputs.release_version }}.zip"
        else
          echo "::set-output name=tag_name::manual-release-${{ steps.date.outputs.today }}"
          echo "::set-output name=release_name::Manual Release ${{ steps.date.outputs.today }}"
          echo "::set-output name=zip_filename::${{ github.repository_name }}-repository-${{ steps.date.outputs.today }}.zip"
        fi
        echo "TAG_NAME=${{ steps.release_info.outputs.tag_name }}" >> $GITHUB_ENV # Speichert den Tag-Namen für Create Release
        echo "ZIP_FILENAME=${{ steps.release_info.outputs.zip_filename }}" >> $GITHUB_ENV # Speichert den ZIP-Dateinamen für Upload Asset

    - name: Create ZIP archive
      run: |
        echo "Creating ${{ env.ZIP_FILENAME }}..."
        zip -r "${{ env.ZIP_FILENAME }}" . -x ".git/*" ".github/workflows/*"

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ env.TAG_NAME }} # Nutzt den dynamisch erzeugten Tag-Namen
        release_name: ${{ steps.release_info.outputs.release_name }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ env.ZIP_FILENAME }}
        asset_name: ${{ env.ZIP_FILENAME }}
        asset_content_type: application/zip
